{% extends "_base.html" %}
{% load i18n %}

{% block title %}{{ product.name }}{% endblock %}

{% block content %}
<div class="container my-5">
  <div class="row g-4">
    <!-- گالری -->
    <div class="col-12 col-lg-6">
      <div class="card">
        {% if product.image %}
          <img id="mainImage" src="{{ product.image.url }}" class="card-img-top" style="object-fit:cover;max-height:460px">
        {% else %}
          <div id="mainImage" class="bg-light d-flex align-items-center justify-content-center" style="height:460px">No Image</div>
        {% endif %}
        <div class="card-body">
          <div class="d-flex gap-2 flex-wrap">
            {% for img in product.images.all %}
              <img src="{{ img.image.url }}" style="height:70px;width:70px;object-fit:cover;cursor:pointer"
                   onclick="document.getElementById('mainImage').src='{{ img.image.url }}'">
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    <!-- اطلاعات محصول -->
    <div class="col-12 col-lg-6">
      <h3 class="mb-1">{{ product.name }}</h3>
      <div class="text-muted mb-2">
        برند: <strong>{{ product.brand.name }}</strong>
        {% if product.category %} | دسته: <strong>{{ product.category.name }}</strong>{% endif %}
      </div>

      <!-- قیمت -->
      <div class="mb-3" id="priceBox">
        {% if product.discount_price %}
          <div class="fs-4 fw-bold"><span id="price">{{ product.discount_price }}</span> <span class="text-muted">تومان</span></div>
          <div class="text-decoration-line-through text-muted">{{ product.price }}</div>
        {% else %}
          <div class="fs-4 fw-bold"><span id="price">{{ product.price }}</span> <span class="text-muted">تومان</span></div>
        {% endif %}
      </div>

      <!-- انتخاب رنگ -->
      <div class="mb-3">
        <label class="form-label">رنگ</label>
        <select id="colorSelect" class="form-select">
          <option value="">انتخاب کنید</option>
          {% for v in product.variations.all %}
            {% if v.color %}<option value="{{ v.color_id }}">{{ v.color.name }}</option>{% endif %}
          {% endfor %}
        </select>
      </div>

      <!-- انتخاب سایز -->
      <div class="mb-3">
        <label class="form-label">سایز</label>
        <select id="sizeSelect" class="form-select">
          <option value="">انتخاب کنید</option>
          {% for v in product.variations.all %}
            {% if v.size %}<option value="{{ v.size_id }}">{{ v.size.name }}</option>{% endif %}
          {% endfor %}
        </select>
      </div>

      <!-- وضعیت و SKU -->
      <div class="mb-3">
        <span class="badge bg-secondary" id="skuBadge">SKU: -</span>
        <span class="badge bg-success ms-2" id="stockBadge">موجودی: -</span>
      </div>

      <div class="d-grid gap-2">
        <button class="btn btn-primary btn-lg" id="addToCartBtn" disabled>افزودن به سبد</button>
        <div class="alert alert-warning d-none" id="variantAlert">لطفاً رنگ و سایز را انتخاب کنید.</div>
      </div>

      <hr>
      <div class="mt-3">
        {{ product.description|linebreaks }}
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  // داده‌ی واریانت‌ها از کانتکست (بدون Ajax)
  const VARIANTS = {{ variants|safe }};

  const colorSel = document.getElementById("colorSelect");
  const sizeSel  = document.getElementById("sizeSelect");
  const priceEl  = document.getElementById("price");
  const skuEl    = document.getElementById("skuBadge");
  const stockEl  = document.getElementById("stockBadge");
  const addBtn   = document.getElementById("addToCartBtn");
  const alertEl  = document.getElementById("variantAlert");
  const mainImg  = document.getElementById("mainImage");

  function findVariant() {
    const c = colorSel.value || null;
    const s = sizeSel.value  || null;

    // جستجوی دقیق (color & size)، و اگر نبود، هرکدام که موجود است
    let v = VARIANTS.find(x => String(x.color_id||"")===String(c||"") && String(x.size_id||"")===String(s||""));
    if (!v && c) v = VARIANTS.find(x => String(x.color_id||"")===String(c||"") && (x.size_id===null || s===""));
    if (!v && s) v = VARIANTS.find(x => String(x.size_id||"")===String(s||"") && (x.color_id===null || c===""));
    return v || null;
  }

  function updateUI() {
    const v = findVariant();
    if (v) {
      priceEl.textContent = v.price;
      skuEl.textContent   = "SKU: " + v.sku;
      stockEl.textContent = "موجودی: " + v.stock;
      addBtn.disabled     = (v.stock <= 0);
      alertEl.classList.add("d-none");
      if (v.image) mainImg.src = v.image;
    } else {
      // برگرداندن به حالت پایه
      skuEl.textContent   = "SKU: -";
      stockEl.textContent = "موجودی: -";
      addBtn.disabled     = true;
      alertEl.classList.remove("d-none");
    }
  }

  colorSel.addEventListener("change", updateUI);
  sizeSel.addEventListener("change", updateUI);
})();
</script>
{% endblock %}
