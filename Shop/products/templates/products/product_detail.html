{% extends "_base.html" %} {% load i18n %} {% block title %}{{ product.name }}{%
endblock %} {% block content %}
<style>
  .pill {
    border: 1px solid #ddd;
    border-radius: 999px;
    padding: 0.5rem 0.9rem;
    cursor: pointer;
    background: #fff;
  }
  .pill.disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  .pill.active {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.15);
  }
  .pill .dot {
    display: inline-block;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    margin-left: 0.4rem;
    vertical-align: middle;
    border: 1px solid #ccc;
  }
  .swatches {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }
</style>

<div class="container my-5">
  <div class="row g-4">
    <!-- تصویر و گالری -->
    <div class="col-12 col-lg-6">
      <div class="card">
        <div class="card-body text-center">
          {% if product.image %}
          <img
            id="mainImage"
            src="{{ product.image.url }}"
            alt="{{ product.name }}"
            class="img-fluid rounded"
          />
          {% else %}
          <img
            id="mainImage"
            src="https://via.placeholder.com/800x800?text=No+Image"
            alt="no image"
            class="img-fluid rounded"
          />
          {% endif %}
        </div>
      </div>

      {% if product.images.all %}
      <div class="d-flex gap-2 mt-3 flex-wrap">
        {% for img in product.images.all %}
        <img
          src="{{ img.image.url }}"
          alt="{{ img.alt_text }}"
          class="img-thumbnail"
          style="width: 84px; height: 84px; object-fit: cover; cursor: pointer"
          onclick="document.getElementById('mainImage').src='{{ img.image.url }}'"
        />
        {% endfor %}
      </div>
      {% endif %}
    </div>

    <!-- جزئیات -->
    <div class="col-12 col-lg-6">
      <h3 class="mb-2">{{ product.name }}</h3>
      <div class="text-muted mb-3">
        {% if product.brand %}<span class="me-2"
          >{% trans "برند" %}: {{ product.brand.name }}</span
        >{% endif %} {% if product.category %}<span
          >{% trans "دسته" %}:
          <a href="{{ product.category.get_absolute_url }}"
            >{{ product.category.name }}</a
          ></span
        >{% endif %}
      </div>

      <!-- قیمت -->
      <div class="mb-3">
        <span class="h4" id="price">{{ product.base_final_price }}</span>
        <span class="text-muted small">{% trans "تومان" %}</span>
      </div>

      <!-- نشان‌ها -->
      <div class="mb-3 d-flex gap-2">
        <span class="badge text-bg-secondary" id="skuBadge">SKU: -</span>
        <span class="badge text-bg-secondary" id="stockBadge"
          >{% trans "موجودی" %}: -</span
        >
      </div>

      <!-- رنگ‌ها (pill) -->
      <div class="mb-3">
        <label class="form-label d-block mb-2">{% trans "رنگ" %}</label>
        <div id="colorPills" class="swatches">
          {% for c in colors %}
          <button type="button" class="pill" data-color="{{ c.id }}">
            <span class="dot" style="background-color: {{ c.hex }};"></span>
            {{ c.name }}
          </button>
          {% endfor %}
        </div>
      </div>

      <!-- سایزها (pill) -->
      <div class="mb-3">
        <label class="form-label d-block mb-2">{% trans "سایز" %}</label>
        <div id="sizePills" class="swatches"></div>
        <div class="form-text" id="sizeHelp" style="display: none"></div>
      </div>

      <!-- فرم سبد -->
      <form
        method="post"
        action="{% url 'cart:add' %}"
        id="addToCartForm"
        class="d-grid gap-2 mt-3"
      >
        {% csrf_token %}
        <input type="hidden" name="variation_id" id="variationIdInput" />
        <div class="row g-2 align-items-center" style="max-width: 420px">
          <div class="col-6">
            <label class="form-label mb-1">{% trans "تعداد" %}</label>
            <input
              type="number"
              name="quantity"
              id="qtyInput"
              min="1"
              value="1"
              class="form-control"
            />
          </div>
          <div class="col-6">
            <label class="form-label mb-1 invisible d-block">.</label>
            <button class="btn btn-primary w-100" id="addToCartBtn" disabled>
              {% trans "افزودن به سبد" %}
            </button>
          </div>
        </div>

        <div class="alert alert-warning d-none mt-2" id="variantAlert">
          {% trans "لطفاً رنگ و سایز را انتخاب کنید." %}
        </div>
        <div class="alert alert-danger d-none mt-2" id="stockAlert">
          {% trans "موجودی کافی نیست." %}
        </div>
      </form>

      {% if product.description %}
      <hr class="my-4" />
      <h5 class="mb-2">{% trans "توضیحات" %}</h5>
      <p class="mb-0">{{ product.description|linebreaks }}</p>
      {% endif %}
    </div>
  </div>
</div>

<script>
  (function() {
    // واریانت‌ها از ویو
    const VARIANTS = {{ variants|safe }};

    const colorWrap = document.getElementById('colorPills');
    const sizeWrap  = document.getElementById('sizePills');

    const priceEl  = document.getElementById('price');
    const skuEl    = document.getElementById('skuBadge');
    const stockEl  = document.getElementById('stockBadge');
    const imgEl    = document.getElementById('mainImage');

    const hidVar   = document.getElementById('variationIdInput');
    const qtyInput = document.getElementById('qtyInput');
    const addBtn   = document.getElementById('addToCartBtn');

    const alertVar   = document.getElementById('variantAlert');
    const alertStock = document.getElementById('stockAlert');

    let selectedColor = null;
    let selectedSize  = null;

    // ابزارک کوچک برای ساخت دکمه سایز
    function sizeButton(label, sizeId, disabled, stock) {
      const b = document.createElement('button');
      b.type = 'button';
      b.className = 'pill';
      b.dataset.size = sizeId ?? '';
      b.textContent = disabled ? `${label} — {{ _('ناموجود') }}` : label;
      if (disabled) b.classList.add('disabled');
      // نمایش موجودی کنار سایز (می‌تونی حذفش کنی)
      if (!disabled && typeof stock === 'number') {
        const small = document.createElement('small');
        small.className = 'ms-2 text-muted';
        small.textContent = `({{ _('موجودی') }}: ${stock})`;
        b.appendChild(small);
      }
      return b;
    }

    // بر اساس رنگ انتخاب‌شده، دکمه‌های سایز بساز
    function rebuildSizes() {
      sizeWrap.innerHTML = '';
      selectedSize = null;

      if (!selectedColor) return;

      // واریانت‌های این رنگ
      const vs = VARIANTS.filter(v => String(v.color_id) === String(selectedColor));

      // گروه‌بندی بر اساس size_id با جمع موجودی
      const map = new Map();
      vs.forEach(v => {
        const key = String(v.size_id || '');
        const current = map.get(key) || {label: v.size || '{{ _("بدون سایز") }}', stock:0, size_id: v.size_id};
        current.stock += Number(v.stock || 0);
        map.set(key, current);
      });

      // ساخت دکمه‌ها
      map.forEach(({label, stock, size_id}) => {
        const btn = sizeButton(label, size_id, stock <= 0, stock);
        btn.addEventListener('click', () => {
          if (btn.classList.contains('disabled')) return;
          // active کردن
          [...sizeWrap.querySelectorAll('.pill')].forEach(x => x.classList.remove('active'));
          btn.classList.add('active');
          selectedSize = size_id;
          updateUI();
        });
        sizeWrap.appendChild(btn);
      });
    }

    // یافتن واریانت دقیق
    function findVariant() {
      if (!selectedColor) return null;

      // اگر سایز تعریف شده، باید match شود؛ اگر محصول بدون سایز است، همان رنگ کافی است
      return VARIANTS.find(v =>
        String(v.color_id||'') === String(selectedColor||'') &&
        String(v.size_id||'')  === String(selectedSize||'')
      ) || null;
    }

    // به‌روزرسانی رابط
    function updateUI() {
      const v = findVariant();

      alertVar.classList.add('d-none');
      alertStock.classList.add('d-none');

      if (v) {
        // قیمت و SKU
        priceEl.textContent = v.price;
        skuEl.textContent = 'SKU: ' + v.sku;

        // موجودی
        if (v.stock > 0) {
          stockEl.textContent = '{{ _("موجودی") }}: ' + v.stock;
          stockEl.className = 'badge text-bg-success';
        } else {
          stockEl.textContent = '{{ _("ناموجود") }}';
          stockEl.className = 'badge text-bg-danger';
        }

        // تصویر
        if (v.image) imgEl.src = v.image;

        // ست کردن آی‌دی برای ارسال
        hidVar.value = v.id;

        // کنترل تعداد درخواستی
        const req = Math.max(1, parseInt(qtyInput.value || '1', 10));
        const enough = v.stock >= req;
        addBtn.disabled = !(v.stock > 0 && enough);
        if (!enough && v.stock > 0) {
          alertStock.classList.remove('d-none');
        }
      } else {
        // واریانت دقیق موجود نیست
        skuEl.textContent = 'SKU: -';
        stockEl.textContent = '{{ _("موجودی") }}: -';
        stockEl.className = 'badge text-bg-secondary';
        addBtn.disabled = true;
        hidVar.value = '';
        if (selectedColor) alertVar.classList.remove('d-none');
      }
    }

    // لیسنر رنگ‌ها (pill)
    colorWrap.querySelectorAll('.pill').forEach(btn => {
      btn.addEventListener('click', () => {
        // active
        colorWrap.querySelectorAll('.pill').forEach(x => x.classList.remove('active'));
        btn.classList.add('active');

        selectedColor = btn.dataset.color;
        selectedSize  = null; // ریست سایز
        rebuildSizes();
        updateUI();
      });
    });

    // تعداد
    qtyInput.addEventListener('input', updateUI);

    // جلوگیری از ارسال بدون واریانت معتبر
    document.getElementById('addToCartForm').addEventListener('submit', function(e){
      if (!hidVar.value) {
        e.preventDefault();
        alertVar.classList.remove('d-none');
      }
    });

  })();
</script>
{% endblock %}
