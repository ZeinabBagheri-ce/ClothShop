{% extends "_base.html" %}
{% load i18n %}

{% block content %}
<div class="container mt-5" style="max-width: 1000px;">
  <h3 class="mb-4 text-center">{% trans "پروفایل من" %}</h3>

  {% if show_password_changed %}
  <script>
  document.addEventListener("DOMContentLoaded", () => {
    const m = new bootstrap.Modal(document.getElementById("passwordChangedModal"));
    m.show();
  });
  </script>
  <div class="modal fade" id="passwordChangedModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">{% trans "موفقیت" %}</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body"><p>{% trans "گذرواژه شما با موفقیت تغییر کرد." %}</p></div>
    </div></div>
  </div>
  {% endif %}

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} mb-3">{{ message }}</div>
    {% endfor %}
  {% endif %}

  <form method="post" enctype="multipart/form-data" class="row g-4">
    {% csrf_token %}

    <div class="col-12 col-lg-6">
      <div class="card">
        <div class="card-header fw-semibold">{% trans "اطلاعات حساب" %}</div>
        <div class="card-body">
          {{ user_form.non_field_errors }}
          <div class="mb-3">
            <label class="form-label">{{ user_form.username.label }}</label>
            {{ user_form.username }} {{ user_form.username.errors }}
          </div>
          <div class="mb-3">
            <label class="form-label">{{ user_form.first_name.label }}</label>
            {{ user_form.first_name }} {{ user_form.first_name.errors }}
          </div>
          <div class="mb-3">
            <label class="form-label">{{ user_form.last_name.label }}</label>
            {{ user_form.last_name }} {{ user_form.last_name.errors }}
          </div>
          <div class="mb-0">
            <label class="form-label">{% trans "ایمیل" %}</label>
            <input type="email" class="form-control" value="{{ request.user.email }}" disabled>
          </div>
        </div>
      </div>
      <a href="{% url 'accounts:password_change' %}" class="btn btn-outline-primary mt-3 w-100">
        {% trans "تغییر گذرواژه" %}
      </a>
    </div>

    <div class="col-12 col-lg-6">
      <div class="card">
        <div class="card-header fw-semibold">{% trans "اطلاعات تکمیلی" %}</div>
        <div class="card-body">
          {{ profile_form.non_field_errors }}
          <div class="mb-3">
            <label class="form-label">{{ profile_form.avatar.label }}</label>
            {{ profile_form.avatar }} {{ profile_form.avatar.errors }}
            {% if request.user.profile.avatar %}
              <div class="mt-2">
                <img src="{{ request.user.profile.avatar.url }}" alt="avatar" class="rounded" style="height:72px">
              </div>
            {% endif %}
          </div>
          <div class="mb-3">
            <label class="form-label">{{ profile_form.phone.label }}</label>
            {{ profile_form.phone }} {{ profile_form.phone.errors }}
            {% if request.user.profile.is_phone_verified %}
              <span class="badge bg-success mt-1">{% trans "تأیید شده" %}</span>
            {% endif %}
          </div>
          <div class="mb-0">
            <label class="form-label">{{ profile_form.date_of_birth.label }}</label>
            {{ profile_form.date_of_birth }} {{ profile_form.date_of_birth.errors }}
          </div>
        </div>
      </div>
    </div>

    {# --------- آدرس‌ها (Formset) --------- #}
    <div class="col-12">
      <div class="card">
        <div class="card-header fw-semibold d-flex justify-content-between align-items-center">
          <span>{% trans "آدرس‌ها" %}</span>
          <button type="button" class="btn btn-sm btn-outline-secondary" id="add-address-btn">
            {% trans "افزودن آدرس" %}
          </button>
        </div>
        <div class="card-body">
          {{ formset.management_form }}
          {{ formset.non_form_errors }}

          <div id="addresses-container">
            {% for form in formset %}
              <div class="border rounded p-3 mb-3 address-item">
                {{ form.non_field_errors }}
                {% if form.id %}{{ form.id }}{% endif %}

                <div class="row g-3">
  <div class="col-md-4">
    {{ form.full_name.label_tag }} {{ form.full_name }} {{ form.full_name.errors }}
  </div>
  <div class="col-md-4">
    {{ form.phone.label_tag }} {{ form.phone }} {{ form.phone.errors }}
  </div>
  <div class="col-md-4">
    {{ form.is_default.label_tag }} {{ form.is_default }} {{ form.is_default.errors }}
  </div>

  <!-- ترتیب جدید: استان → شهر → آدرس دقیق → توضیحات -->
  <div class="col-md-3">
    {{ form.province.label_tag }} {{ form.province }} {{ form.province.errors }}
  </div>
  <div class="col-md-3">
    {{ form.city.label_tag }} {{ form.city }} {{ form.city.errors }}
  </div>
  <div class="col-md-6">
    {{ form.address_exact.label_tag }} {{ form.address_exact }} {{ form.address_exact.errors }}
  </div>

  <div class="col-md-12">
    {{ form.description.label_tag }} {{ form.description }} {{ form.description.errors }}
  </div>

  <div class="col-md-3">
    {{ form.postal_code.label_tag }} {{ form.postal_code }} {{ form.postal_code.errors }}
  </div>
  <div class="col-md-3">
    {{ form.country.label_tag }} {{ form.country }} {{ form.country.errors }}
  </div>

  {% if form.DELETE %}
    <div class="col-12 form-check mt-2">
      {{ form.DELETE }} <label class="form-check-label">{{ form.DELETE.label }}</label>
    </div>
  {% endif %}
</div>

              </div>
            {% empty %}
              <p class="text-muted mb-0">{% trans "آدرسی ثبت نشده است." %}</p>
            {% endfor %}
          </div>

          {# --- الگوی empty_form صحیح با province + city --- #}
          <template id="empty-form-template">
  <div class="border rounded p-3 mb-3 address-item">
    {{ formset.empty_form.non_field_errors }}
    <div class="row g-3">
      <div class="col-md-4">{{ formset.empty_form.full_name.label_tag }} {{ formset.empty_form.full_name }}</div>
      <div class="col-md-4">{{ formset.empty_form.phone.label_tag }} {{ formset.empty_form.phone }}</div>
      <div class="col-md-4">{{ formset.empty_form.is_default.label_tag }} {{ formset.empty_form.is_default }}</div>

      <div class="col-md-3">{{ formset.empty_form.province.label_tag }} {{ formset.empty_form.province }}</div>
      <div class="col-md-3">{{ formset.empty_form.city.label_tag }} {{ formset.empty_form.city }}</div>
      <div class="col-md-6">{{ formset.empty_form.address_exact.label_tag }} {{ formset.empty_form.address_exact }}</div>

      <div class="col-md-12">{{ formset.empty_form.description.label_tag }} {{ formset.empty_form.description }}</div>

      <div class="col-md-3">{{ formset.empty_form.postal_code.label_tag }} {{ formset.empty_form.postal_code }}</div>
      <div class="col-md-3">{{ formset.empty_form.country.label_tag }} {{ formset.empty_form.country }}</div>
    </div>
  </div>
</template>


        </div>
      </div>
    </div>

    <div class="col-12">
      <button type="submit" class="btn btn-success w-100 mt-2">{% trans "ذخیره تغییرات" %}</button>
    </div>
  </form>
</div>

{# ---- JS: افزودن آدرس + وابستگی استان→شهر ---- #}
<script>
(function () {
  const addBtn     = document.getElementById("add-address-btn");
  const formEl     = document.querySelector("form");
  const container  = document.getElementById("addresses-container");
  const totalInput = document.querySelector('input[name$="-TOTAL_FORMS"]');
  const tmpl       = document.getElementById("empty-form-template");

  if (addBtn && formEl && totalInput) {
    function replacePrefix(node, index) {
      node.querySelectorAll("input, select, textarea, label").forEach(el => {
        ["name","id","for"].forEach(attr => {
          if (el.hasAttribute(attr)) {
            el.setAttribute(attr, el.getAttribute(attr).replace("__prefix__", index));
          }
        });
        if (el.tagName === "INPUT") {
          if (["text","tel","email"].includes(el.type)) el.value = "";
          if (["checkbox","radio"].includes(el.type)) el.checked = false;
        }
        if (el.tagName === "TEXTAREA") el.value = "";
        if (el.tagName === "SELECT") el.selectedIndex = 0;
      });
    }

    addBtn.addEventListener("click", function () {
      const index = parseInt(totalInput.value || "0", 10);
      if (tmpl && container) {
        const fragment = tmpl.content.cloneNode(true);
        replacePrefix(fragment, index);
        container.appendChild(fragment);
        totalInput.value = index + 1;
      } else {
        // fallback: اگر template نبود، از سرور فرم خالی بگیر
        totalInput.value = index + 1;
        formEl.submit();
      }
    });
  }

  // استان → شهر (event delegation برای فرم‌های جدید هم کار می‌کند)
  const container2 = document.getElementById("addresses-container");
  if (!container2) return;

  function optionEl(value, text) {
    const o = document.createElement("option");
    o.value = value; o.textContent = text; return o;
  }

  container2.addEventListener("change", async function (e) {
    const target = e.target;
    if (!target.matches('select[name$="-province"]')) return;

    const formRow = target.closest(".address-item");
    if (!formRow) return;

    const citySelect = formRow.querySelector('select[name$="-city"]');
    if (!citySelect) return;

    citySelect.innerHTML = "";
    citySelect.appendChild(optionEl("", "در حال بارگذاری..."));

    const provId = target.value;
    if (!provId) {
      citySelect.innerHTML = "";
      citySelect.appendChild(optionEl("", "ابتدا استان را انتخاب کنید"));
      return;
    }

    try {
      const resp = await fetch("{% url 'accounts:ajax_cities' %}?province_id=" + encodeURIComponent(provId));
      const data = await resp.json();
      citySelect.innerHTML = "";
      citySelect.appendChild(optionEl("", "انتخاب شهر"));
      (data.results || []).forEach(c => {
        citySelect.appendChild(optionEl(c.id, c.name));
      });
    } catch (err) {
      citySelect.innerHTML = "";
      citySelect.appendChild(optionEl("", "خطا در دریافت شهرها"));
      console.error(err);
    }
  });
})();
</script>
{% endblock %}
